package file

import (
	"fmt"

	"github.com/easayliu/alist-aria2-download/internal/interfaces/telegram/utils"
	"github.com/easayliu/alist-aria2-download/pkg/logger"
	tgbotapi "github.com/go-telegram-bot-api/telegram-bot-api/v5"
)

// ================================
// æ–‡ä»¶æµè§ˆåŠŸèƒ½
// ================================

// HandleBrowseFiles å¤„ç†æ–‡ä»¶æµè§ˆï¼ˆæ”¯æŒåˆ†é¡µå’Œäº¤äº’ï¼‰
func (h *Handler) HandleBrowseFiles(chatID int64, path string, page int) {
	h.HandleBrowseFilesWithEdit(chatID, path, page, 0) // 0 è¡¨ç¤ºå‘é€æ–°æ¶ˆæ¯
}

// HandleBrowseFilesWithEdit å¤„ç†æ–‡ä»¶æµè§ˆï¼ˆæ”¯æŒæ¶ˆæ¯ç¼–è¾‘å’Œåˆ†é¡µï¼‰
func (h *Handler) HandleBrowseFilesWithEdit(chatID int64, path string, page int, messageID int) {
	if path == "" {
		path = "/"
	}
	if page < 1 {
		page = 1
	}

	logger.Info("Browsing files", "path", path, "page", page, "messageID", messageID)

	msgUtils := h.deps.GetMessageUtils()

	// ä»…åœ¨å‘é€æ–°æ¶ˆæ¯æ—¶æ˜¾ç¤ºæç¤º
	if messageID == 0 {
		msgUtils.SendMessage(chatID, "æ­£åœ¨è·å–æ–‡ä»¶åˆ—è¡¨...")
	}

	// è·å–æ–‡ä»¶åˆ—è¡¨ï¼ˆæ¯é¡µæ˜¾ç¤º8ä¸ªæ–‡ä»¶ï¼Œä¸ºæŒ‰é’®å¸ƒå±€é¢„ç•™ç©ºé—´ï¼‰
	files, err := h.ListFilesSimple(path, page, 8)
	if err != nil {
		formatter := msgUtils.GetFormatter().(*utils.MessageFormatter)
		msgUtils.SendMessage(chatID, formatter.FormatError("è·å–æ–‡ä»¶åˆ—è¡¨", err))
		return
	}

	if len(files) == 0 {
		msgUtils.SendMessageHTMLWithAutoDelete(chatID, "å½“å‰ç›®å½•ä¸ºç©º", 30)
		return
	}

	// ç»Ÿè®¡æ–‡ä»¶ä¿¡æ¯
	dirCount := 0
	fileCount := 0
	videoCount := 0
	fileService := h.deps.GetFileService()
	for _, file := range files {
		if file.IsDir {
			dirCount++
		} else {
			fileCount++
			if fileService.IsVideoFile(file.Name) {
				videoCount++
			}
		}
	}

	// ä½¿ç”¨ç»Ÿä¸€æ ¼å¼åŒ–å™¨
	formatter := msgUtils.GetFormatter().(*utils.MessageFormatter)
	browserData := utils.FileBrowserData{
		Path:       path,
		Page:       page,
		TotalPages: 1,
		TotalFiles: len(files),
		DirCount:   dirCount,
		FileCount:  fileCount,
		VideoCount: videoCount,
		EscapeHTML: msgUtils.EscapeHTML,
	}
	message := formatter.FormatFileBrowser(browserData)
	message += "\n"

	// æ„å»ºå†…è”é”®ç›˜
	var keyboard [][]tgbotapi.InlineKeyboardButton

	for _, file := range files {
		var prefix string
		var callbackData string

		if file.IsDir {
			prefix = "ğŸ“"
			fullPath := h.BuildFullPath(file, path)
			callbackData = fmt.Sprintf("browse_dir:%s:1", h.deps.EncodeFilePath(fullPath))
		} else if fileService.IsVideoFile(file.Name) {
			prefix = "ğŸ¬"
			fullPath := h.BuildFullPath(file, path)
			callbackData = fmt.Sprintf("file_menu:%s", h.deps.EncodeFilePath(fullPath))
		} else {
			prefix = "ğŸ“„"
			fullPath := h.BuildFullPath(file, path)
			callbackData = fmt.Sprintf("file_menu:%s", h.deps.EncodeFilePath(fullPath))
		}

		fileName := file.Name
		maxWidth := 38
		if !file.IsDir {
			maxWidth = 30
		}

		btnFormatter := msgUtils.GetFormatter().(*utils.MessageFormatter)
		fileName = btnFormatter.TruncateButtonText(fileName, maxWidth)

		button := tgbotapi.NewInlineKeyboardButtonData(
			fmt.Sprintf("%s %s", prefix, fileName),
			callbackData,
		)

		keyboard = append(keyboard, []tgbotapi.InlineKeyboardButton{button})
	}

	// æ·»åŠ å¯¼èˆªæŒ‰é’®
	navButtons := []tgbotapi.InlineKeyboardButton{}

	// ä¸Šä¸€é¡µæŒ‰é’®
	if page > 1 {
		navButtons = append(navButtons, tgbotapi.NewInlineKeyboardButtonData(
			"< ä¸Šä¸€é¡µ",
			fmt.Sprintf("browse_page:%s:%d", h.deps.EncodeFilePath(path), page-1),
		))
	}

	// ä¸‹ä¸€é¡µæŒ‰é’®ï¼ˆå¦‚æœå½“å‰é¡µå·²æ»¡ï¼Œå¯èƒ½è¿˜æœ‰æ›´å¤šï¼‰
	if len(files) == 8 {
		navButtons = append(navButtons, tgbotapi.NewInlineKeyboardButtonData(
			"ä¸‹ä¸€é¡µ >",
			fmt.Sprintf("browse_page:%s:%d", h.deps.EncodeFilePath(path), page+1),
		))
	}

	if len(navButtons) > 0 {
		keyboard = append(keyboard, navButtons)
	}

	// æ·»åŠ æ“ä½œæŒ‰é’® - ç¬¬ä¸€è¡Œï¼šä¸‹è½½å’Œåˆ·æ–°
	actionRow1 := []tgbotapi.InlineKeyboardButton{
		tgbotapi.NewInlineKeyboardButtonData("ğŸ“¥ ä¸‹è½½ç›®å½•", fmt.Sprintf("download_dir:%s", h.deps.EncodeFilePath(path))),
		tgbotapi.NewInlineKeyboardButtonData("ğŸ“ æ‰¹é‡é‡å‘½å", fmt.Sprintf("batch_rename:%s", h.deps.EncodeFilePath(path))),
		tgbotapi.NewInlineKeyboardButtonData("ğŸ”„ åˆ·æ–°", fmt.Sprintf("browse_refresh:%s:%d", h.deps.EncodeFilePath(path), page)),
	}
	keyboard = append(keyboard, actionRow1)

	// æ·»åŠ å¯¼èˆªæŒ‰é’® - ç¬¬äºŒè¡Œï¼šä¸Šçº§ç›®å½•ã€åˆ é™¤ç›®å½•å’Œä¸»èœå•
	actionRow2 := []tgbotapi.InlineKeyboardButton{}

	// è¿”å›ä¸Šçº§ç›®å½•æŒ‰é’®
	if path != "/" {
		parentPath := h.GetParentPath(path)
		actionRow2 = append(actionRow2, tgbotapi.NewInlineKeyboardButtonData(
			"â¬†ï¸ ä¸Šçº§ç›®å½•",
			fmt.Sprintf("browse_dir:%s:%d", h.deps.EncodeFilePath(parentPath), 1),
		))
	}

	// åˆ é™¤ç›®å½•æŒ‰é’®ï¼ˆä»…éæ ¹ç›®å½•ï¼‰
	if path != "/" {
		actionRow2 = append(actionRow2, tgbotapi.NewInlineKeyboardButtonData(
			"ğŸ—‘ï¸ åˆ é™¤ç›®å½•",
			fmt.Sprintf("dir_delete_confirm:%s", h.deps.EncodeFilePath(path)),
		))
	}

	// è¿”å›ä¸»èœå•æŒ‰é’®
	actionRow2 = append(actionRow2, tgbotapi.NewInlineKeyboardButtonData("ğŸ  ä¸»èœå•", "back_main"))

	if len(actionRow2) > 0 {
		keyboard = append(keyboard, actionRow2)
	}

	inlineKeyboard := tgbotapi.NewInlineKeyboardMarkup(keyboard...)

	if messageID > 0 {
		msgUtils.EditMessageWithKeyboard(chatID, messageID, message, "HTML", &inlineKeyboard)
	} else {
		msgUtils.SendMessageWithKeyboard(chatID, message, "HTML", &inlineKeyboard)
	}
}

// HandleFilesBrowseWithEdit å¤„ç†æ–‡ä»¶æµè§ˆï¼ˆæ”¯æŒæ¶ˆæ¯ç¼–è¾‘ï¼‰
func (h *Handler) HandleFilesBrowseWithEdit(chatID int64, messageID int) {
	defaultPath := h.deps.GetConfig().Alist.DefaultPath
	if defaultPath == "" {
		defaultPath = "/"
	}
	h.HandleBrowseFilesWithEdit(chatID, defaultPath, 1, messageID)
}

// HandleAlistFilesWithEdit å¤„ç†è·å– Alist æ–‡ä»¶åˆ—è¡¨ï¼ˆæ”¯æŒæ¶ˆæ¯ç¼–è¾‘ï¼‰
func (h *Handler) HandleAlistFilesWithEdit(chatID int64, messageID int) {
	h.HandleBrowseFilesWithEdit(chatID, h.deps.GetConfig().Alist.DefaultPath, 1, messageID)
}
